{"version":3,"sources":["../yjs/node_modules/browser-pack/_prelude.js","src/Map.js","y-map.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length",1,"module","_classCallCheck","instance","Constructor","TypeError","extend","Y","YMap","os","model","contents","opContents","_this","this","_model","id","map","utils","copyObject","eventHandler","EventHandler","ops","userEvents","oldValue","op","key","struct","parentSub","prevType","Promise","resolve","requestTransaction","regeneratorRuntime","mark","_callee","type","wrap","_context","prev","next","delegateYield","getType","t0","stop","left","value","opContent","_callee2","_context2","deleted","content","insertEvent","undefined","name","object","push","compareIds","target","deleteEvent","callEventListeners","_createClass","destroy","_this2","oid","_callee3","_context3","Object","keys","concat","_this3","_callee4","_context4","reject","right","del","modDel","awaitAndPrematurelyCall","_callee5","_context5","applyCreatedOperations","awaitedDeletes","_this4","insert","origin","parent","typeDefinition","isTypeDefinition","_callee6","_context6","createType","store","getNextOpId","_callee7","_context7","awaitedInserts","addEventListener","removeEventListener","path","observeProperty","events","event","propertyName","property","self","get","then","observe","unobserve","deleteChildObservers","resetObserverPath","promise","set","Map","observePath","slice","_deleteChildObservers","observer","_changed","transaction","_context8","getOperation","receivedOp","CustomType","class","initType","YMapInitializer","_context9","t1","done","t2","abrupt","defineProperties","props","descriptor","enumerable","configurable","writable","defineProperty","protoProps","staticProps","prototype"],"mappings":"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","file":"y-map.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/* global Y */\n'use strict'\n\nfunction extend (Y /* :any */) {\n  class YMap {\n    /* ::\n    _model: Id;\n    os: Y.AbstractDatabase;\n    map: Object;\n    contents: any;\n    opContents: Object;\n    eventHandler: Function;\n    */\n    constructor (os, model, contents, opContents) {\n      this._model = model.id\n      this.os = os\n      this.map = Y.utils.copyObject(model.map)\n      this.contents = contents\n      this.opContents = opContents\n      this.eventHandler = new Y.utils.EventHandler(ops => {\n        var userEvents = []\n        for (var i = 0; i < ops.length; i++) {\n          var op = ops[i]\n          var oldValue\n          // key is the name to use to access (op)content\n          var key = op.struct === 'Delete' ? op.key : op.parentSub\n\n          // compute oldValue\n          if (this.opContents[key] != null) {\n            let prevType = this.opContents[key]\n            oldValue = () => {// eslint-disable-line\n              return new Promise((resolve) => {\n                this.os.requestTransaction(function *() {// eslint-disable-line\n                  var type = yield* this.getType(prevType)\n                  resolve(type)\n                })\n              })\n            }\n          } else {\n            oldValue = this.contents[key]\n          }\n          // compute op event\n          if (op.struct === 'Insert') {\n            if (op.left === null) {\n              var value\n              // TODO: what if op.deleted??? I partially handles this case here.. (maybe from the previous version)\n              if (op.opContent != null) {\n                value = () => {// eslint-disable-line\n                  return new Promise((resolve) => {\n                    this.os.requestTransaction(function *() {// eslint-disable-line\n                      var type = yield* this.getType(op.opContent)\n                      resolve(type)\n                    })\n                  })\n                }\n                delete this.contents[key]\n                if (op.deleted) {\n                  delete this.opContents[key]\n                } else {\n                  this.opContents[key] = op.opContent\n                }\n              } else {\n                value = op.content[0]\n                delete this.opContents[key]\n                if (op.deleted) {\n                  delete this.contents[key]\n                } else {\n                  this.contents[key] = op.content[0]\n                }\n              }\n              this.map[key] = op.id\n              var insertEvent\n              if (oldValue === undefined) {\n                insertEvent = {\n                  name: key,\n                  object: this,\n                  type: 'add',\n                  value: value\n                }\n              } else {\n                insertEvent = {\n                  name: key,\n                  object: this,\n                  oldValue: oldValue,\n                  type: 'update',\n                  value: value\n                }\n              }\n              userEvents.push(insertEvent)\n            }\n          } else if (op.struct === 'Delete') {\n            if (Y.utils.compareIds(this.map[key], op.target)) {\n              delete this.opContents[key]\n              delete this.contents[key]\n              var deleteEvent = {\n                name: key,\n                object: this,\n                oldValue: oldValue,\n                type: 'delete'\n              }\n              userEvents.push(deleteEvent)\n            }\n          } else {\n            throw new Error('Unexpected Operation!')\n          }\n        }\n        if (userEvents.length > 0) {\n          this.eventHandler.callEventListeners(userEvents)\n        }\n      })\n    }\n    _destroy () {\n      this.eventHandler.destroy()\n      this.eventHandler = null\n      this.contents = null\n      this.opContents = null\n      this._model = null\n      this.os = null\n      this.map = null\n    }\n    get (key) {\n      // return property.\n      // if property does not exist, return null\n      // if property is a type, return a promise\n      if (key == null || typeof key !== 'string') {\n        throw new Error('You must specify a key (as string)!')\n      }\n      if (this.opContents[key] == null) {\n        return this.contents[key]\n      } else {\n        return new Promise((resolve) => {\n          var oid = this.opContents[key]\n          this.os.requestTransaction(function *() {\n            var type = yield* this.getType(oid)\n            resolve(type)\n          })\n        })\n      }\n    }\n    keys () {\n      return Object.keys(this.contents).concat(Object.keys(this.opContents))\n    }\n    keysPrimitives () {\n      return Object.keys(this.contents)\n    }\n    keysTypes () {\n      return Object.keys(this.opContents)\n    }\n    /*\n      If there is a primitive (not a custom type), then return it.\n      Returns all primitive values, if propertyName is specified!\n      Note: modifying the return value could result in inconsistencies!\n        -- so make sure to copy it first!\n    */\n    getPrimitive (key) {\n      if (key == null) {\n        return Y.utils.copyObject(this.contents)\n      } else if (typeof key !== 'string') {\n        throw new Error('Key is expected to be a string!')\n      } else {\n        return this.contents[key]\n      }\n    }\n    getType (key) {\n      if (key == null || typeof key !== 'string') {\n        throw new Error('You must specify a key (as string)!')\n      } else if (this.opContents[key] != null) {\n        return new Promise((resolve) => {\n          var oid = this.opContents[key]\n          this.os.requestTransaction(function *() {\n            var type = yield* this.getType(oid)\n            resolve(type)\n          })\n        })\n      } else {\n        return Promise.reject('No property specified for this key!')\n      }\n    }\n    delete (key) {\n      var right = this.map[key]\n      if (right != null) {\n        var del = {\n          target: right,\n          struct: 'Delete'\n        }\n        var eventHandler = this.eventHandler\n        var modDel = Y.utils.copyObject(del)\n        modDel.key = key\n        eventHandler.awaitAndPrematurelyCall([modDel])\n        this.os.requestTransaction(function *() {\n          yield* this.applyCreatedOperations([del])\n          eventHandler.awaitedDeletes(1)\n        })\n      }\n    }\n    set (key, value) {\n      // set property.\n      // if property is a type, return a promise\n      // if not, apply immediately on this type an call event\n\n      var right = this.map[key] || null\n      var insert /* :any */ = {\n        left: null,\n        right: right,\n        origin: null,\n        parent: this._model,\n        parentSub: key,\n        struct: 'Insert'\n      }\n      return new Promise((resolve) => {\n        var typeDefinition = Y.utils.isTypeDefinition(value)\n        if (typeDefinition !== false) {\n          // construct a new type\n          this.os.requestTransaction(function *() {\n            var type = yield* this.createType(typeDefinition)\n            insert.opContent = type._model\n            insert.id = this.store.getNextOpId(1)\n            yield* this.applyCreatedOperations([insert])\n            resolve(type)\n          })\n        } else {\n          insert.content = [value]\n          insert.id = this.os.getNextOpId(1)\n          var eventHandler = this.eventHandler\n          eventHandler.awaitAndPrematurelyCall([insert])\n          this.os.requestTransaction(function *() {\n            yield* this.applyCreatedOperations([insert])\n            eventHandler.awaitedInserts(1)\n          })\n          resolve(value)\n        }\n      })\n    }\n    observe (f) {\n      this.eventHandler.addEventListener(f)\n    }\n    unobserve (f) {\n      this.eventHandler.removeEventListener(f)\n    }\n    /*\n      Observe a path.\n\n      E.g.\n      ```\n      o.set('textarea', Y.TextBind)\n      o.observePath(['textarea'], function(t){\n        // is called whenever textarea is replaced\n        t.bind(textarea)\n      })\n\n      returns a Promise that contains a function that removes the observer from the path.\n    */\n    observePath (path, f) {\n      var self = this\n      function observeProperty (events) {\n        // call f whenever path changes\n        for (var i = 0; i < events.length; i++) {\n          var event = events[i]\n          if (event.name === propertyName) {\n            // call this also for delete events!\n            var property = self.get(propertyName)\n            if (property instanceof Promise) {\n              property.then(f)\n            } else {\n              f(property)\n            }\n          }\n        }\n      }\n\n      if (path.length < 1) {\n        throw new Error('Path must contain at least one element!')\n      } else if (path.length === 1) {\n        var propertyName = path[0]\n        var property = self.get(propertyName)\n        if (property instanceof Promise) {\n          property.then(f)\n        } else {\n          f(property)\n        }\n        this.observe(observeProperty)\n        return Promise.resolve(function () {\n          self.unobserve(f)\n        })\n      } else {\n        var deleteChildObservers\n        var resetObserverPath = function () {\n          var promise = self.get(path[0])\n          if (!promise instanceof Promise) {\n            // its either not defined or a primitive value\n            promise = self.set(path[0], Y.Map)\n          }\n          return promise.then(function (map) {\n            return map.observePath(path.slice(1), f)\n          }).then(function (_deleteChildObservers) {\n            // update deleteChildObservers\n            deleteChildObservers = _deleteChildObservers\n            return Promise.resolve() // Promise does not return anything\n          })\n        }\n        var observer = function (events) {\n          for (var e = 0; e < events.length; e++) {\n            var event = events[e]\n            if (event.name === path[0]) {\n              if (deleteChildObservers != null) {\n                deleteChildObservers()\n              }\n              if (event.type === 'add' || event.type === 'update') {\n                resetObserverPath()\n              }\n              // TODO: what about the delete events?\n            }\n          }\n        }\n        self.observe(observer)\n        return resetObserverPath().then(\n          // this promise contains a function that deletes all the child observers\n          // and how to unobserve the observe from this object\n          new Promise.resolve(function () { // eslint-disable-line\n            if (deleteChildObservers != null) {\n              deleteChildObservers()\n            }\n            self.unobserve(observer)\n          })\n        )\n      }\n    }\n    * _changed (transaction, op) {\n      if (op.struct === 'Delete') {\n        var target = yield* transaction.getOperation(op.target)\n        op.key = target.parentSub\n      }\n      this.eventHandler.receivedOp(op)\n    }\n  }\n  Y.extend('Map', new Y.utils.CustomType({\n    name: 'Map',\n    class: YMap,\n    struct: 'Map',\n    initType: function * YMapInitializer (os, model) {\n      var contents = {}\n      var opContents = {}\n      var map = model.map\n      for (var name in map) {\n        var op = yield* this.getOperation(map[name])\n        if (op.opContent != null) {\n          opContents[name] = op.opContent\n        } else {\n          contents[name] = op.content[0]\n        }\n      }\n      return new YMap(os, model, contents, opContents)\n    }\n  }))\n}\n\nmodule.exports = extend\nif (typeof Y !== 'undefined') {\n  extend(Y)\n}\n","(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n/* global Y */\n'use strict';\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction extend(Y /* :any */) {\n  var YMap = function () {\n    /* ::\n    _model: Id;\n    os: Y.AbstractDatabase;\n    map: Object;\n    contents: any;\n    opContents: Object;\n    eventHandler: Function;\n    */\n\n    function YMap(os, model, contents, opContents) {\n      var _this = this;\n\n      _classCallCheck(this, YMap);\n\n      this._model = model.id;\n      this.os = os;\n      this.map = Y.utils.copyObject(model.map);\n      this.contents = contents;\n      this.opContents = opContents;\n      this.eventHandler = new Y.utils.EventHandler(function (ops) {\n        var userEvents = [];\n        for (var i = 0; i < ops.length; i++) {\n          var op = ops[i];\n          var oldValue;\n          // key is the name to use to access (op)content\n          var key = op.struct === 'Delete' ? op.key : op.parentSub;\n\n          // compute oldValue\n          if (_this.opContents[key] != null) {\n            (function () {\n              var prevType = _this.opContents[key];\n              oldValue = function oldValue() {\n                // eslint-disable-line\n                return new Promise(function (resolve) {\n                  _this.os.requestTransaction(regeneratorRuntime.mark(function _callee() {\n                    var type;\n                    return regeneratorRuntime.wrap(function _callee$(_context) {\n                      while (1) {\n                        switch (_context.prev = _context.next) {\n                          case 0:\n                            return _context.delegateYield(this.getType(prevType), 't0', 1);\n\n                          case 1:\n                            type = _context.t0;\n\n                            resolve(type);\n\n                          case 3:\n                          case 'end':\n                            return _context.stop();\n                        }\n                      }\n                    }, _callee, this);\n                  }));\n                });\n              };\n            })();\n          } else {\n            oldValue = _this.contents[key];\n          }\n          // compute op event\n          if (op.struct === 'Insert') {\n            if (op.left === null) {\n              var value;\n              // TODO: what if op.deleted??? I partially handles this case here.. (maybe from the previous version)\n              if (op.opContent != null) {\n                value = function value() {\n                  // eslint-disable-line\n                  return new Promise(function (resolve) {\n                    _this.os.requestTransaction(regeneratorRuntime.mark(function _callee2() {\n                      var type;\n                      return regeneratorRuntime.wrap(function _callee2$(_context2) {\n                        while (1) {\n                          switch (_context2.prev = _context2.next) {\n                            case 0:\n                              return _context2.delegateYield(this.getType(op.opContent), 't0', 1);\n\n                            case 1:\n                              type = _context2.t0;\n\n                              resolve(type);\n\n                            case 3:\n                            case 'end':\n                              return _context2.stop();\n                          }\n                        }\n                      }, _callee2, this);\n                    }));\n                  });\n                };\n                delete _this.contents[key];\n                if (op.deleted) {\n                  delete _this.opContents[key];\n                } else {\n                  _this.opContents[key] = op.opContent;\n                }\n              } else {\n                value = op.content[0];\n                delete _this.opContents[key];\n                if (op.deleted) {\n                  delete _this.contents[key];\n                } else {\n                  _this.contents[key] = op.content[0];\n                }\n              }\n              _this.map[key] = op.id;\n              var insertEvent;\n              if (oldValue === undefined) {\n                insertEvent = {\n                  name: key,\n                  object: _this,\n                  type: 'add',\n                  value: value\n                };\n              } else {\n                insertEvent = {\n                  name: key,\n                  object: _this,\n                  oldValue: oldValue,\n                  type: 'update',\n                  value: value\n                };\n              }\n              userEvents.push(insertEvent);\n            }\n          } else if (op.struct === 'Delete') {\n            if (Y.utils.compareIds(_this.map[key], op.target)) {\n              delete _this.opContents[key];\n              delete _this.contents[key];\n              var deleteEvent = {\n                name: key,\n                object: _this,\n                oldValue: oldValue,\n                type: 'delete'\n              };\n              userEvents.push(deleteEvent);\n            }\n          } else {\n            throw new Error('Unexpected Operation!');\n          }\n        }\n        if (userEvents.length > 0) {\n          _this.eventHandler.callEventListeners(userEvents);\n        }\n      });\n    }\n\n    _createClass(YMap, [{\n      key: '_destroy',\n      value: function _destroy() {\n        this.eventHandler.destroy();\n        this.eventHandler = null;\n        this.contents = null;\n        this.opContents = null;\n        this._model = null;\n        this.os = null;\n        this.map = null;\n      }\n    }, {\n      key: 'get',\n      value: function get(key) {\n        var _this2 = this;\n\n        // return property.\n        // if property does not exist, return null\n        // if property is a type, return a promise\n        if (key == null || typeof key !== 'string') {\n          throw new Error('You must specify a key (as string)!');\n        }\n        if (this.opContents[key] == null) {\n          return this.contents[key];\n        } else {\n          return new Promise(function (resolve) {\n            var oid = _this2.opContents[key];\n            _this2.os.requestTransaction(regeneratorRuntime.mark(function _callee3() {\n              var type;\n              return regeneratorRuntime.wrap(function _callee3$(_context3) {\n                while (1) {\n                  switch (_context3.prev = _context3.next) {\n                    case 0:\n                      return _context3.delegateYield(this.getType(oid), 't0', 1);\n\n                    case 1:\n                      type = _context3.t0;\n\n                      resolve(type);\n\n                    case 3:\n                    case 'end':\n                      return _context3.stop();\n                  }\n                }\n              }, _callee3, this);\n            }));\n          });\n        }\n      }\n    }, {\n      key: 'keys',\n      value: function keys() {\n        return Object.keys(this.contents).concat(Object.keys(this.opContents));\n      }\n    }, {\n      key: 'keysPrimitives',\n      value: function keysPrimitives() {\n        return Object.keys(this.contents);\n      }\n    }, {\n      key: 'keysTypes',\n      value: function keysTypes() {\n        return Object.keys(this.opContents);\n      }\n      /*\n        If there is a primitive (not a custom type), then return it.\n        Returns all primitive values, if propertyName is specified!\n        Note: modifying the return value could result in inconsistencies!\n          -- so make sure to copy it first!\n      */\n\n    }, {\n      key: 'getPrimitive',\n      value: function getPrimitive(key) {\n        if (key == null) {\n          return Y.utils.copyObject(this.contents);\n        } else if (typeof key !== 'string') {\n          throw new Error('Key is expected to be a string!');\n        } else {\n          return this.contents[key];\n        }\n      }\n    }, {\n      key: 'getType',\n      value: function getType(key) {\n        var _this3 = this;\n\n        if (key == null || typeof key !== 'string') {\n          throw new Error('You must specify a key (as string)!');\n        } else if (this.opContents[key] != null) {\n          return new Promise(function (resolve) {\n            var oid = _this3.opContents[key];\n            _this3.os.requestTransaction(regeneratorRuntime.mark(function _callee4() {\n              var type;\n              return regeneratorRuntime.wrap(function _callee4$(_context4) {\n                while (1) {\n                  switch (_context4.prev = _context4.next) {\n                    case 0:\n                      return _context4.delegateYield(this.getType(oid), 't0', 1);\n\n                    case 1:\n                      type = _context4.t0;\n\n                      resolve(type);\n\n                    case 3:\n                    case 'end':\n                      return _context4.stop();\n                  }\n                }\n              }, _callee4, this);\n            }));\n          });\n        } else {\n          return Promise.reject('No property specified for this key!');\n        }\n      }\n    }, {\n      key: 'delete',\n      value: function _delete(key) {\n        var right = this.map[key];\n        if (right != null) {\n          var del = {\n            target: right,\n            struct: 'Delete'\n          };\n          var eventHandler = this.eventHandler;\n          var modDel = Y.utils.copyObject(del);\n          modDel.key = key;\n          eventHandler.awaitAndPrematurelyCall([modDel]);\n          this.os.requestTransaction(regeneratorRuntime.mark(function _callee5() {\n            return regeneratorRuntime.wrap(function _callee5$(_context5) {\n              while (1) {\n                switch (_context5.prev = _context5.next) {\n                  case 0:\n                    return _context5.delegateYield(this.applyCreatedOperations([del]), 't0', 1);\n\n                  case 1:\n                    eventHandler.awaitedDeletes(1);\n\n                  case 2:\n                  case 'end':\n                    return _context5.stop();\n                }\n              }\n            }, _callee5, this);\n          }));\n        }\n      }\n    }, {\n      key: 'set',\n      value: function set(key, value) {\n        var _this4 = this;\n\n        // set property.\n        // if property is a type, return a promise\n        // if not, apply immediately on this type an call event\n\n        var right = this.map[key] || null;\n        var insert /* :any */ = {\n          left: null,\n          right: right,\n          origin: null,\n          parent: this._model,\n          parentSub: key,\n          struct: 'Insert'\n        };\n        return new Promise(function (resolve) {\n          var typeDefinition = Y.utils.isTypeDefinition(value);\n          if (typeDefinition !== false) {\n            // construct a new type\n            _this4.os.requestTransaction(regeneratorRuntime.mark(function _callee6() {\n              var type;\n              return regeneratorRuntime.wrap(function _callee6$(_context6) {\n                while (1) {\n                  switch (_context6.prev = _context6.next) {\n                    case 0:\n                      return _context6.delegateYield(this.createType(typeDefinition), 't0', 1);\n\n                    case 1:\n                      type = _context6.t0;\n\n                      insert.opContent = type._model;\n                      insert.id = this.store.getNextOpId(1);\n                      return _context6.delegateYield(this.applyCreatedOperations([insert]), 't1', 5);\n\n                    case 5:\n                      resolve(type);\n\n                    case 6:\n                    case 'end':\n                      return _context6.stop();\n                  }\n                }\n              }, _callee6, this);\n            }));\n          } else {\n            insert.content = [value];\n            insert.id = _this4.os.getNextOpId(1);\n            var eventHandler = _this4.eventHandler;\n            eventHandler.awaitAndPrematurelyCall([insert]);\n            _this4.os.requestTransaction(regeneratorRuntime.mark(function _callee7() {\n              return regeneratorRuntime.wrap(function _callee7$(_context7) {\n                while (1) {\n                  switch (_context7.prev = _context7.next) {\n                    case 0:\n                      return _context7.delegateYield(this.applyCreatedOperations([insert]), 't0', 1);\n\n                    case 1:\n                      eventHandler.awaitedInserts(1);\n\n                    case 2:\n                    case 'end':\n                      return _context7.stop();\n                  }\n                }\n              }, _callee7, this);\n            }));\n            resolve(value);\n          }\n        });\n      }\n    }, {\n      key: 'observe',\n      value: function observe(f) {\n        this.eventHandler.addEventListener(f);\n      }\n    }, {\n      key: 'unobserve',\n      value: function unobserve(f) {\n        this.eventHandler.removeEventListener(f);\n      }\n      /*\n        Observe a path.\n         E.g.\n        ```\n        o.set('textarea', Y.TextBind)\n        o.observePath(['textarea'], function(t){\n          // is called whenever textarea is replaced\n          t.bind(textarea)\n        })\n         returns a Promise that contains a function that removes the observer from the path.\n      */\n\n    }, {\n      key: 'observePath',\n      value: function observePath(path, f) {\n        var self = this;\n        function observeProperty(events) {\n          // call f whenever path changes\n          for (var i = 0; i < events.length; i++) {\n            var event = events[i];\n            if (event.name === propertyName) {\n              // call this also for delete events!\n              var property = self.get(propertyName);\n              if (property instanceof Promise) {\n                property.then(f);\n              } else {\n                f(property);\n              }\n            }\n          }\n        }\n\n        if (path.length < 1) {\n          throw new Error('Path must contain at least one element!');\n        } else if (path.length === 1) {\n          var propertyName = path[0];\n          var property = self.get(propertyName);\n          if (property instanceof Promise) {\n            property.then(f);\n          } else {\n            f(property);\n          }\n          this.observe(observeProperty);\n          return Promise.resolve(function () {\n            self.unobserve(f);\n          });\n        } else {\n          var deleteChildObservers;\n          var resetObserverPath = function resetObserverPath() {\n            var promise = self.get(path[0]);\n            if (!promise instanceof Promise) {\n              // its either not defined or a primitive value\n              promise = self.set(path[0], Y.Map);\n            }\n            return promise.then(function (map) {\n              return map.observePath(path.slice(1), f);\n            }).then(function (_deleteChildObservers) {\n              // update deleteChildObservers\n              deleteChildObservers = _deleteChildObservers;\n              return Promise.resolve(); // Promise does not return anything\n            });\n          };\n          var observer = function observer(events) {\n            for (var e = 0; e < events.length; e++) {\n              var event = events[e];\n              if (event.name === path[0]) {\n                if (deleteChildObservers != null) {\n                  deleteChildObservers();\n                }\n                if (event.type === 'add' || event.type === 'update') {\n                  resetObserverPath();\n                }\n                // TODO: what about the delete events?\n              }\n            }\n          };\n          self.observe(observer);\n          return resetObserverPath().then(\n          // this promise contains a function that deletes all the child observers\n          // and how to unobserve the observe from this object\n          new Promise.resolve(function () {\n            // eslint-disable-line\n            if (deleteChildObservers != null) {\n              deleteChildObservers();\n            }\n            self.unobserve(observer);\n          }));\n        }\n      }\n    }, {\n      key: '_changed',\n      value: regeneratorRuntime.mark(function _changed(transaction, op) {\n        var target;\n        return regeneratorRuntime.wrap(function _changed$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                if (!(op.struct === 'Delete')) {\n                  _context8.next = 4;\n                  break;\n                }\n\n                return _context8.delegateYield(transaction.getOperation(op.target), 't0', 2);\n\n              case 2:\n                target = _context8.t0;\n\n                op.key = target.parentSub;\n\n              case 4:\n                this.eventHandler.receivedOp(op);\n\n              case 5:\n              case 'end':\n                return _context8.stop();\n            }\n          }\n        }, _changed, this);\n      })\n    }]);\n\n    return YMap;\n  }();\n\n  Y.extend('Map', new Y.utils.CustomType({\n    name: 'Map',\n    class: YMap,\n    struct: 'Map',\n    initType: regeneratorRuntime.mark(function YMapInitializer(os, model) {\n      var contents, opContents, map, name, op;\n      return regeneratorRuntime.wrap(function YMapInitializer$(_context9) {\n        while (1) {\n          switch (_context9.prev = _context9.next) {\n            case 0:\n              contents = {};\n              opContents = {};\n              map = model.map;\n              _context9.t0 = regeneratorRuntime.keys(map);\n\n            case 4:\n              if ((_context9.t1 = _context9.t0()).done) {\n                _context9.next = 11;\n                break;\n              }\n\n              name = _context9.t1.value;\n              return _context9.delegateYield(this.getOperation(map[name]), 't2', 7);\n\n            case 7:\n              op = _context9.t2;\n\n              if (op.opContent != null) {\n                opContents[name] = op.opContent;\n              } else {\n                contents[name] = op.content[0];\n              }\n              _context9.next = 4;\n              break;\n\n            case 11:\n              return _context9.abrupt('return', new YMap(os, model, contents, opContents));\n\n            case 12:\n            case 'end':\n              return _context9.stop();\n          }\n        }\n      }, YMapInitializer, this);\n    })\n  }));\n}\n\nmodule.exports = extend;\nif (typeof Y !== 'undefined') {\n  extend(Y);\n}\n\n},{}]},{},[1])\n\n"],"sourceRoot":"/source/"}